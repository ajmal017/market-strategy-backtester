<!doctype html>
<html>

<head>
    <title>Market Strategy Backtester</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="./main.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    <link href='https://fonts.googleapis.com/css?family=Passion+One' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Oxygen' rel='stylesheet' type='text/css'>
</head>

<body>
    <div class="container">
        <div class="row main">
            <div class="main-login main-center">
            <h5>Market Strategy Backtester</h5>
            <p>Upload and check your Strategy.</p>
                <form class="" method="post" action="#">
                    
                    <div class="form-group">
                        <label for="call_threshold" class="cols-sm-2 control-label">Call Threshold</label>
                        <div class="cols-sm-10">
                            <div class="input-group">
                                <span class="input-group-addon"><i class="fa fa-genderless fa" aria-hidden="true"></i></span>
                                <input type="text" class="form-control" name="call_threshold" id="call_threshold"  placeholder="Enter Call Threshold"/>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="put_threshold" class="cols-sm-2 control-label">Put Threshold</label>
                        <div class="cols-sm-10">
                            <div class="input-group">
                                <span class="input-group-addon"><i class="fa fa-genderless fa" aria-hidden="true"></i></span>
                                <input type="text" class="form-control" name="put_threshold" id="put_threshold"  placeholder="Enter Put Threshold"/>
                            </div>
                        </div>
                    </div>

                    <div class="form-group ">
                        <input type="file" name="datafile" id="inputFile" accept=".xlsx" onchange="allowOnlyXlsx(this);" type="button" id="button" class="btn btn-primary btn-lg btn-block"></input>
                    </div>

                    <div class="form-group ">
                        <a target="_blank" type="button" id="button" class="btn btn-primary btn-lg btn-block login-button">Register</a>
                    </div>
                    
                </form>
            </div>
        </div>
    </div>
    <div style="margin-left: 200px;margin-top: 50px">
        <div class="row">
            <table id="callTable" class="display" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Date Time</th>
                        <th>Bid</th>
                        <th>Offer</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <table id="putTable" class="display" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Date Time</th>
                        <th>Bid</th>
                        <th>Offer</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</body>

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
<script>
        var isAjax = false;
        $(function() {
            hideProgressBar();

            var callTable = $('#callTable').DataTable({"ordering": false});
            var putTable = $('#putTable').DataTable({"ordering": false});

            $('#upload-excel').click(function() {

                $("#filename").val('');
                if (!isAjax) {
                    hideProgressBar();
                }
            });

            $('form').submit(function(e) {
                $('#upload').modal('close');
                isAjax = true;
                var formData = new FormData($(this)[0]);
                // formData.append('callThreshold', $('#call_threshold').val());
                // formData.append('putThreshold', $('#call_threshold').val());
                var confirmation = confirm("Are you sure?");
                if (confirmation) {
                    $.ajax({
                        type: 'POST',
                        url: '/historical-data',
                        data: formData,
                        contentType: false,
                        processData: false
                    }).done(function(data) {
                        alert("Successfully Processed");
                        renderData(data.callResult, 'callTable');
                        renderData(data.putResult, 'putTable');
                        isAjax = false;
                    }).fail(function(err) {
                        alert(err.message);
                    });
                } else {
                        location.reload();
                }
            e.preventDefault();
            });
        });
        
        //entry function
        function allowOnlyXlsx(sender) {
            showProgressBar();
            var validExts = new Array(".xlsx");
            var fileExt = sender.value;
            fileExt = fileExt.substring(fileExt.lastIndexOf('.'));
            if (validExts.indexOf(fileExt) < 0) {
                alert("Invalid file selected, valid files are of " + validExts.toString() + " types.");
                return false;
            } else {
                $('form').submit();
            }
        }
        function hideProgressBar() {
            $('.progress').hide();
        }

        function showProgressBar() {
            $('.progress').show();
        }

        function renderData(data, id){
            for(i=0 ; i<data.length ; i++){
                $(`#${id} tbody`).before(`
                    <tr class="child">
                        <td>${data[i].Time}<\/td>
                        <td>${data[i].Bid}<\/td>
                        <td>${data[i].Offer}<\/td>
                    </tr>`);
            }
        }
</script>

</html>